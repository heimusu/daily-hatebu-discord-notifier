name: Daily Random Hatena Bookmark
on:
  schedule:
    - cron:  '0 22 * * *'     # JST 07:00
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install deps
        run: npm install rss-parser axios

      - name: Pick & notify Discord
        env:
          RSS_URL: "https://b.hatena.ne.jp/${{ secrets.HATEBU_USER }}/rss"
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          node <<'JS'
          const axios   = require('axios');
          const Parser  = require('rss-parser');

          // "&" â†’ "&amp;" ã«ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
          const fixBrokenEntities = (xml) =>
            xml.replace(/&(?!#?\w+;)/g, '&amp;');

          (async () => {
            // 1. RSS æ–‡å­—åˆ—ã‚’å–å¾—
            const raw = (await axios.get(process.env.RSS_URL)).data;

            // 2. â€œå£Šã‚ŒãŸ &â€ ã‚’ä¿®æ­£
            const safeXml = fixBrokenEntities(raw);

            // 3. ãƒ‘ãƒ¼ã‚¹ï¼ˆæ–‡å­—åˆ— â†’ ãƒ•ã‚£ãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
            const parser = new Parser();           // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ OK
            const feed   = await parser.parseString(safeXml);

            // 4. ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º
            const pick = feed.items[Math.floor(Math.random()*feed.items.length)];

            // 5. Discord ã¸é€šçŸ¥
            await axios.post(process.env.DISCORD_WEBHOOK_URL, {
              username: "Hatena Random",
              avatar_url: "https://b.hatena.ne.jp/favicon.ico",
              embeds: [{
                title: pick.title,
                url:   pick.link,
                description: "ðŸŽ² ä»Šæ—¥ã®ã¯ã¦ãƒ–",
                footer: { text: "æä¾›: GitHub Actions" }
              }]
            });
            console.log(`Sent: ${pick.title}`);
          })().catch(err => {
            console.error('FAIL', err);
            process.exit(1);
          });
          JS

