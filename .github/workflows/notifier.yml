name: Daily Random Hatena Bookmark
on:
  schedule:
    - cron:  '0 22 * * *'     # JST 07:00
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install deps
        run: npm install rss-parser axios

      - name: Pick & notify Discord
        env:
          RSS_URL: "https://b.hatena.ne.jp/${{ secrets.HATEBU_USER }}/rss" # ‚Üê‚ë† URL‰øÆÊ≠£
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          node <<'JS'
          const axios  = require('axios');
          const Parser = require('rss-parser');

          // 1) "&" ‚Üí "&amp;" „ÇíË£úÊ≠£
          const fixBrokenEntities = (xml) =>
            xml.replace(/&(?!#?\w+;)/g, '&amp;');

          // 2) RSS / Atom „Çâ„Åó„ÅÑ„ÅãÁ∞°ÊòìÂà§ÂÆö
          const looksLikeFeed = (s) => /<(rss|feed|rdf:RDF)\b/i.test(s);

          (async () => {
            // --- RSSÂèñÂæó ---
            const res = await axios.get(process.env.RSS_URL, {
              responseType: 'text',
              headers: {
                'User-Agent': 'HatenaRandomBot/1.0 (+https://github.com/<repo>)',
                'Accept': 'application/rss+xml, application/xml;q=0.9, */*;q=0.8'
              },
              validateStatus: s => s >= 200 && s < 400
            });

            if (!looksLikeFeed(res.data)) {
              throw new Error(
                `Unexpected response (status ${res.status}, type ${res.headers['content-type']})`
              );
            }

            // --- "&" „ÅÆ‰øÆÂæ© + „Éë„Éº„Çπ ---
            const safeXml = fixBrokenEntities(res.data);
            const parser  = new Parser({ xml2js: { strict: false } });
            const feed    = await parser.parseString(safeXml);

            // --- „É©„É≥„ÉÄ„É†ÊäΩÂá∫ ---
            if (!feed.items?.length) throw new Error('No items in feed');
            const pick = feed.items[Math.floor(Math.random() * feed.items.length)];

            // --- DiscordÈÄöÁü• ---
            await axios.post(process.env.DISCORD_WEBHOOK_URL, {
              username: 'Hatena Random',
              avatar_url: 'https://b.hatena.ne.jp/favicon.ico',
              embeds: [{
                title: pick.title,
                url:   pick.link,
                description: 'üé≤ ‰ªäÊó•„ÅÆ„ÅØ„Å¶„Éñ',
                footer: { text: 'Êèê‰æõ: GitHub Actions' }
              }]
            });
            console.log(`Sent: ${pick.title}`);
          })().catch(err => {
            console.error('FAIL', err.message || err);
            process.exit(1);
          });
          JS

